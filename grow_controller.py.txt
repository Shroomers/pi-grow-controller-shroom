#!/usr/bin/python

import RPi.GPIO as GPIO
import time
import board
import adafruit_scd4x

# 1. --- Hardware GPIO Assignments ---
OUTSIDE_FAN_PIN = 27
INSIDE_FAN_PIN = 22
HUMIDIFIER_PIN = 23

# 2. --- Sensor and GPIO Initialization ---
i2c = board.I2C()
scd4x = adafruit_scd4x.SCD4X(i2c)
scd4x.start_periodic_measurement()

GPIO.setmode(GPIO.BCM)
GPIO.setwarnings(False)

GPIO.setup(OUTSIDE_FAN_PIN, GPIO.OUT)
GPIO.setup(INSIDE_FAN_PIN, GPIO.OUT)
GPIO.setup(HUMIDIFIER_PIN, GPIO.OUT)

GPIO.output(OUTSIDE_FAN_PIN, GPIO.LOW)
GPIO.output(INSIDE_FAN_PIN, GPIO.LOW)
GPIO.output(HUMIDIFIER_PIN, GPIO.LOW)

is_humidifying = False
is_venting_co2 = False

# 3. --- Main Control Loop ---
try:
    while True:
        if scd4x.data_ready:
            temperature_c = scd4x.temperature
            humidity = scd4x.relative_humidity
            co2 = scd4x.CO2
            temperature_f = temperature_c * (9/5) + 32

            print("--------------------")
            print(f"CO2: {co2} ppm")
            print(f"Temp: {temperature_c:.1f} C ({temperature_f:.1f} F)")
            print(f"Humidity: {humidity:.1f} %")
            print("--------------------")

            if humidity < 85:
                is_humidifying = True
            elif humidity >= 95:
                is_humidifying = False

            if co2 > 800:
                is_venting_co2 = True
            elif co2 <= 700:
                is_venting_co2 = False

            if is_humidifying:
                GPIO.output(HUMIDIFIER_PIN, GPIO.HIGH)
            else:
                GPIO.output(HUMIDIFIER_PIN, GPIO.LOW)

            if is_venting_co2:
                GPIO.output(OUTSIDE_FAN_PIN, GPIO.HIGH)
            else:
                GPIO.output(OUTSIDE_FAN_PIN, GPIO.LOW)

            if is_humidifying or is_venting_co2:
                GPIO.output(INSIDE_FAN_PIN, GPIO.HIGH)
            else:
                GPIO.output(INSIDE_FAN_PIN, GPIO.LOW)

        time.sleep(10)

except KeyboardInterrupt:
    print("Stopping controller and cleaning up GPIO.")
    GPIO.cleanup()
